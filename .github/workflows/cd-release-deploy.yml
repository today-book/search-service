name: CD (release) - Deploy to Prod

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Deploy version tag (e.g. 1.2.3)"
        required: true
      sha:
        description: "Commit SHA to deploy (optional if version tag exists)"
        required: false
      update_latest:
        description: "Also move :latest to this version? (after both servers succeed)"
        required: false
        type: choice
        options: ["true", "false"]
        default: "true"

permissions:
  contents: read
  packages: write
  id-token: write

concurrency:
  group: deploy-prod-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

  # App
  APP_NAME: search-service
  APP_PORT: 9005

  # AWS
  AWS_REGION_PROD: ap-northeast-2

  # SSM target tags
  PROD_ENV_TAG_KEY: "tag:Env"
  PROD_ENV_TAG_VALUE: "prod"

  PROD1_NODE_TAG_KEY: "tag:Node"
  PROD1_NODE_TAG_VALUE: "api-bundle-1"

  PROD2_NODE_TAG_KEY: "tag:Node"
  PROD2_NODE_TAG_VALUE: "api-bundle-2"

jobs:
  # 1) 이미지 준비
  prepare-image:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      version: ${{ steps.out.outputs.version }}
      update_latest: ${{ steps.out.outputs.update_latest }}
    steps:
      - name: Resolve VERSION
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          else
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV
          fi

      - name: Resolve UPDATE_LATEST
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "UPDATE_LATEST=true" >> $GITHUB_ENV
          else
            echo "UPDATE_LATEST=${{ inputs.update_latest || 'true' }}" >> $GITHUB_ENV
          fi

      - uses: actions/checkout@v4
        with:
          ref: ${{ env.VERSION }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure version image exists
        run: |
          set -euo pipefail
          TARGET="${REGISTRY}/${IMAGE_NAME}:${VERSION}"
          docker buildx imagetools inspect "$TARGET" >/dev/null 2>&1 && exit 0

          if [[ -z "${{ inputs.sha }}" ]]; then
            echo "❌ Image not found and SHA not provided"
            exit 1
          fi

          SRC="${REGISTRY}/${IMAGE_NAME}:main-${{ inputs.sha }}"
          docker buildx imagetools create "$SRC" --tag "$TARGET"

      - id: out
        run: |
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "update_latest=${UPDATE_LATEST}" >> $GITHUB_OUTPUT

  # 2) PROD-1 배포
  deploy-prod-1:
    needs: prepare-image
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION_PROD }}
          role-to-assume: ${{ secrets.AWS_DEPLOY_PROD_ROLE_ARN }}
          role-session-name: gha-ssm-deploy

      - name: Deploy to prod-1 via SSM
        env:
          VERSION: ${{ needs.prepare-image.outputs.version }}
          GHCR_USER: ${{ secrets.GHCR_USER }}
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
        run: |
          set -euo pipefail

          SCRIPT=$(cat <<'EOS'
  #!/bin/sh
  set -eu
  exec /bin/bash -lc '
  set -euo pipefail
  cd /srv/todaybook/search-service
  echo "$GHCR_PAT" | sudo docker login ghcr.io -u "$GHCR_USER" --password-stdin
  chmod +x deploy.sh
  ./deploy.sh
  '
EOS
          )

          PARAMS=$(python3 - <<'PY'
  import json, os
print(json.dumps({"commands": os.environ["SCRIPT"].splitlines()}))
  PY
  )
  
  CMD_ID=$(aws ssm send-command \
  --document-name AWS-RunShellScript \
  --comment "Deploy search-service:${VERSION} to prod-1" \
  --targets \
  "Key=tag:Env,Values=prod" \
  "Key=tag:Node,Values=api-bundle-1" \
  --parameters "$PARAMS" \
  --query "Command.CommandId" \
  --output text)
  
  echo "SSM CommandId=$CMD_ID"
  
  while true; do
  STATUS=$(aws ssm list-command-invocations \
  --command-id "$CMD_ID" --details \
  --query "CommandInvocations[0].Status" \
  --output text 2>/dev/null || true)
  
  [[ -z "$STATUS" || "$STATUS" == "None" ]] && sleep 3 && continue
echo "SSM status: $STATUS"
  
  case "$STATUS" in
  Success) break ;;
  Failed|Cancelled|TimedOut)
  aws ssm list-command-invocations --command-id "$CMD_ID" --details
  exit 1 ;;
  *) sleep 5 ;;
  esac
  done

# 3) PROD-2 배포
deploy-prod-2:
  needs: [ prepare-image, deploy-prod-1 ]
  runs-on: ubuntu-latest
  steps:
    - uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: ${{ env.AWS_REGION_PROD }}
        role-to-assume: ${{ secrets.AWS_DEPLOY_PROD_ROLE_ARN }}
        role-session-name: gha-ssm-deploy

    - name: Deploy to prod-2 via SSM
      env:
        VERSION: ${{ needs.prepare-image.outputs.version }}
        GHCR_USER: ${{ secrets.GHCR_USER }}
        GHCR_PAT: ${{ secrets.GHCR_PAT }}
      run: |
        set -euo pipefail
        
        SCRIPT=$(cat <<'EOS'
  #!/bin/sh
  set -eu
  exec /bin/bash -lc '
  set -euo pipefail
  cd /srv/todaybook/search-service
  echo "$GHCR_PAT" | sudo docker login ghcr.io -u "$GHCR_USER" --password-stdin
  chmod +x deploy.sh
  ./deploy.sh
  '
EOS
          )

          PARAMS=$(python3 - <<'PY'
  import json, os
print(json.dumps({"commands": os.environ["SCRIPT"].splitlines()}))
  PY
  )
  
  aws ssm send-command \
  --document-name AWS-RunShellScript \
  --comment "Deploy search-service:${VERSION} to prod-2" \
  --targets \
  "Key=tag:Env,Values=prod" \
  "Key=tag:Node,Values=api-bundle-2" \
  --parameters "$PARAMS"

# 4) latest 태그 갱신
update-latest:
  needs: [ prepare-image, deploy-prod-1, deploy-prod-2 ]
  if: ${{ needs.prepare-image.outputs.update_latest == 'true' }}
  runs-on: ubuntu-latest
  steps:
    - uses: docker/setup-buildx-action@v3
    - uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - run: |
        docker buildx imagetools create \
          "${REGISTRY}/${IMAGE_NAME}:${{ needs.prepare-image.outputs.version }}" \
          --tag "${REGISTRY}/${IMAGE_NAME}:latest"
